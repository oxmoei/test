# macOS 浏览器数据备份与恢复工具

## ⚠️ 重要警告

**此工具处理极度敏感的数据（Cookies 和密码），请务必：**

1. **仅在自己的设备上使用**
2. **不要分享导出文件给任何人**
3. **导出文件使用固定密码 `cookies2026` 加密**
4. **使用完毕后立即删除导出文件**
5. **不要上传到云存储或公共网络**
6. **妥善保管脚本文件（包含加密密码）**

---

## 功能说明

### 1. 导出工具 (`export_browser_data.py`)
- 从 Chrome/Safari/Brave 浏览器导出 Cookies 和密码
- 使用 AES-256-GCM 加密导出文件
- 自动使用预设密码 `cookies2026` 加密

### 2. 导入工具 (`import_browser_data.py`)
- 将加密的备份文件导入到新环境的浏览器
- 自动备份现有浏览器数据
- 支持选择导入文件

---

## 环境要求

### 操作系统
- **macOS 10.15+**

### Python 版本
- Python 3.7+

### 依赖库
```bash
pip3 install pycryptodome
```

---

## 使用方法

### 步骤 1：导出浏览器数据

1. 运行导出脚本（**无需关闭浏览器**）：
```bash
chmod +x 导出浏览器数据.sh
./导出浏览器数据.sh
# 或直接运行
python3 export_browser_data.py
```

2. 脚本将自动使用预设密码 `cookies2026` 加密数据

3. 导出文件保存在 `exports/` 目录，格式为：
   ```
   browser_data_YYYYMMDD_HHMMSS.encrypted
   ```

**注意**：脚本支持在浏览器运行时导出数据，使用了以下技术：
- 文件系统级复制（允许读取被锁定文件）
- SQLite 在线备份 API（作为备用方案）

### 步骤 2：备份导出文件

将 `exports/` 目录中的 `.encrypted` 文件**安全备份**：
- 使用加密的 U 盘或移动硬盘
- 或上传到**私有**加密云存储（需二次加密）
- **不要**使用公共云盘或邮箱

### 步骤 3：在新环境导入

1. 将 `.encrypted` 文件复制到新机器的 `exports/` 目录

2. **关闭所有浏览器窗口**（重要！）

3. 运行导入脚本：
```bash
chmod +x 导入浏览器数据.sh
./导入浏览器数据.sh
# 或直接运行
python3 import_browser_data.py
```

4. 选择要导入的文件编号

5. 脚本将自动使用预设密码 `cookies2026` 解密

6. 确认导入（输入 `yes`）

7. **重启浏览器**以应用更改

---

## 导出文件内容

加密文件包含：
- **Cookies**：网站登录状态、偏好设置
- **密码**：保存的网站密码

导出格式（加密前）：
```json
{
  "export_time": "2026-01-19 12:00:00",
  "username": "用户名",
  "platform": "macOS",
  "browsers": {
    "Chrome": {
      "cookies": [...],
      "passwords": [...],
      "cookies_count": 100,
      "passwords_count": 50
    },
    "Safari": {
      ...
    },
    "Brave": {
      ...
    }
  }
}
```

---

## 安全建议

### 加密密码
- 脚本使用预设密码 `cookies2026` 自动加密/解密
- 此密码已硬编码在脚本中，方便自动化使用
- ⚠️ **重要**：确保导出文件的存储安全，因为密码是固定的

### 文件存储
- **不要**将导出文件与脚本存放在同一公共位置
- 导入完成后**立即删除**导出文件
- 定期更换加密密码（需修改脚本）

### 使用场景
- ✅ 新电脑迁移数据（跨用户账户）
- ✅ 系统重装前备份（可用于新用户账户）
- ✅ 多设备同步（私有）
- ❌ 分享给他人
- ❌ 上传到公共网络
- ❌ 长期存储（建议定期重新导出）

---

## 故障排除

### 问题 1：需要 Keychain 访问权限
- **原因**：脚本需要访问 macOS Keychain 获取浏览器主密钥
- **解决**：在弹出的权限对话框中点击"允许"或"始终允许"

### 问题 2：导入失败
- **原因**：浏览器正在运行
- **解决**：完全关闭浏览器（包括后台进程）

### 问题 3：Safari 数据不完整
- **原因**：Safari 使用系统 Keychain 存储密码，可能需要额外权限
- **解决**：运行脚本时授予所有请求的权限

### 问题 4：导入后数据不显示
- **原因**：未重启浏览器
- **解决**：完全关闭并重启浏览器

---

## 技术原理

### 浏览器加密机制
- **Chrome/Brave** 使用 **macOS Keychain + AES-128-CBC** 加密敏感数据
- **Safari** 直接使用 **macOS Keychain** 存储密码
- 主密钥存储在 Keychain 中（"Chrome Safe Storage" 等）
- Cookies 存储在 SQLite 数据库（`Cookies`）
- 密码存储在 SQLite 数据库（`Login Data`）

### 在线导出技术
**不关闭浏览器也能导出的原理**：

1. **文件系统特性**
   - macOS 允许读取被进程锁定的文件
   - 使用二进制读取绕过某些锁定限制

2. **SQLite 在线备份**
   - 使用 `sqlite3.Connection.backup()` API
   - 以只读模式打开数据库（`mode=ro`）
   - 不影响浏览器的正常使用

3. **多重尝试机制**
   - 优先使用直接复制（最快）
   - 失败时使用二进制读写
   - 最后尝试 SQLite 在线备份

**注意**：虽然支持在线导出，但数据可能略有延迟（浏览器可能还在写入新数据）

### 导出加密流程
1. 从浏览器数据库读取加密数据
2. 使用 **macOS Keychain** 获取主密钥
3. 使用主密钥解密 Cookies 和密码为**明文**
4. 使用预设密码 `cookies2026`（PBKDF2 + AES-256-GCM）加密导出文件

### 导入流程
1. 使用密码 `cookies2026` 解密导出文件（获得明文数据）
2. 获取**目标 Mac**浏览器主密钥（从 Keychain）
3. 使用目标主密钥**重新加密**数据
4. 写入目标浏览器数据库

**关键点**：脚本在中间环节将数据转换为明文，因此不受 Keychain 用户绑定限制

---

## 限制说明

### 跨用户账户支持

**✅ 本脚本支持跨 macOS 用户账户使用**

**原理说明**：
1. **导出阶段**：在用户 A 的账户下从 Keychain 获取密钥并解密为明文
2. **中间存储**：使用预设密码 `cookies2026` 加密存储（AES-256-GCM）
3. **导入阶段**：在用户 B 的账户下解密备份文件，并用用户 B 的 Keychain 重新加密

**与直接复制的区别**：
- ❌ **直接复制**：数据库文件 → 失败（Keychain 绑定原用户）
- ✅ **本脚本**：数据库 → 明文 → 加密备份 → 明文 → 重新加密 → 成功

**适用场景**：
- 同一台 Mac 不同用户账户之间迁移
- 不同 Mac 之间迁移
- 系统重装后恢复（新用户账户）

### 支持范围
**✅ 支持**：
- macOS 10.15+ 系统
- Chrome、Safari 和 Brave 浏览器
- 跨 macOS 用户账户使用
- 跨 Mac 迁移

**❌ 不支持**：
- Windows/Linux 系统（加密机制不同）
- Firefox（使用不同的加密机制）
- 其他 Chromium 浏览器（可能需要调整路径）

### 已知限制
- 部分网站可能需要重新登录（Cookie 过期或额外验证机制）
- Safari 的某些数据可能需要额外的 Keychain 权限
- 导入后首次使用可能需要重新验证某些敏感操作

---

## 许可与责任

- 此工具**仅供个人学习和合法使用**
- 使用者需承担所有责任和风险
- 作者不对数据丢失或安全问题负责
- **禁止用于非法目的**

---

## 相关文件

```
备份浏览器cookies和密码/macos/
├── README.md                   # 本文档
├── export_browser_data.py      # 导出工具
├── import_browser_data.py      # 导入工具
├── 导出浏览器数据.sh           # 导出快捷启动
├── 导入浏览器数据.sh           # 导入快捷启动
└── exports/                    # 导出文件目录（自动创建）
    └── browser_data_*.encrypted
```

---

## macOS 特殊说明

### Keychain 访问
- 首次运行时，macOS 会要求授权访问 Keychain
- 选择"始终允许"可避免重复提示
- 脚本只读取浏览器相关的密钥，不会访问其他数据

### Safari 支持
- Safari 的加密机制与 Chrome/Brave 不同
- 密码可能直接存储在系统 Keychain 中
- 某些 Safari 数据可能需要额外权限

### 脚本权限
运行前需要给脚本执行权限：
```bash
chmod +x 导出浏览器数据.sh
chmod +x 导入浏览器数据.sh
```

---

## 更新日志

### v1.0.0 (2026-01-19)
- 初始版本
- 支持 Chrome、Safari 和 Brave
- AES-256-GCM 加密
- 自动备份功能
- 支持浏览器运行时导出
